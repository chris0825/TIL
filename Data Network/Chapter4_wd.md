# Chapter 4 네트워크 계층: 데이터 평면
## 4.1 네트워크 계층 개요
### 포워딩(전달, Forwarding)
  - 패킷이 라우터의 입력 링크에 도달했을 때 라우터가 그 패킷을 적절한 출력 링크로 이동시키는 것
### 라우팅 알고리즘(Routing Algorithm)
  - 송신자가 수신자에게 패킷을 전송할 때 네트워크 계층이 패킷 경로를 결정하는 알고리즘
### 포워딩 테이블(Forwarding Table)
### SDN(Software Defined Networking)
### 네트워크 서비스 모델(Network Service Model)
  - 보장된 전달
    > 패킷이 출발지 호스트에서부터 목적지 호스트까지 도착하는것을 보장
  - 지연 제한 이내의 보장된 전달
    > 패킷의 전달을 보장할 뿐만 아니라 호스트 간의 특정 지연 제한 안에 전달
  - 순서화 패킷 전달
    > 패킷이 목적지에 송신된 순서대로 도착하는것을 보장
  - 최소 대역폭 보장
    > 송신과 수신 호스트 사이에 특정한 비트율의 전송 링크를 에뮬레이트하여 특정한 비트율 이하로 전송하는 한, 모든 패킷이 목적지 호스트까지 전달된다.
    > 
  - 보안 서비스
### 최선형 서비스(Best-Effort Service)
  - 순서화 패킷 보장 안함
  - 목적지까지 전달 보장 안됨
  - 종단 시스템단 지연 보장 안됨
  - 보장된 최소 대역폭 없음
## 4.2 라우터 내부에는 무엇이 있을까?
### > 라우터의 네가지 요소
  - 입력 포트(Input Port)
  - 스위치 구조
    - 라우터의 입력 포트와 출력포트 연결
  - 출력 포트(Output Port)
    - 스위치 구조에서 수신한 패킷을 저장하고 필요한 링크 계층 및 물리 계층 기능을 수행하여 출력 링크로 패킷 전송
  - 라우팅 프로세서
    - 제어 평면 기능 수행
### 제어 평면(Control Plane)
  - 데이터 평면이 나노초 단위로 작동하는 동안 라우터의 제어 기능은 밀리초 또는 2초 단위로 작동한다.
  - 일반적으로 소프트웨어로 구현되며 라우팅 프로세서에서 실행
### > 교차로 진입 절차
  - 목적지 기반 포워딩
    1. 자동차가 진입 장소에서 정차하고 최종 목적지를 표시.
    2. 입구에 있는 승무원이 최종 목적지를 검색하고 최종 목적지로 연결되는 출구를 결정한 후 운전자에게 출구 안내
  - 일반화된 포워딩
    - 승무원은 목적지 외에도 많은 요인을 토대로 자동차의 출구 결정
      - 특정 주의 자동차는 하나의 출구를 사용하게 할 수 있지만 다른 주에서는 출구를 사용하도록 지시할 수 있다
      - 자동차의 모델, 제조사, 연식에 따라 동일한 결정이 내려질 수 있다
      - 주행하기 안전하지 않은 차는 차단되거나 회전교차로 이용금지
### 프리픽스(Prefix)
### TCAM(Ternary Content Addressable Memory)
  = 검색을 위해 자주 사용됨
### > 스위칭(포워딩)
  - 메모리를 통한 교환
    - 목적지 주소를 검색하고 해당 메모리 위치에 패킷을 저장하는 것이 입력 라인 카드에서 처리함으로써 수행됨
    - 라인카드에서 패킷을 처리하여 적절한 출력 포트의 메모리로 스위칭(쓰기)함
  - 버스를 통한 교환
    - 입력 포트는 라우팅 프로세서의 개입 없이 공유 버스를 통해 직접 출력 포트로 패킷을 전송
  - 상호연결 네트워크를 통한 교환
    - 크로스바 스위치(Crossbar Switch): N개의 입력 포트를 N개의 출력포트에 연결하는 2N버스로 구성된 상호연결 네트워크
    - 다단계 스위치 구조
### 패킷 손실
  - 큐가 더 커지면 라우터의 메모리가 결국 소모될 수 있고 도착하는 패킷을 저장할 수 있는 메모리가 없을때 발생
### HOL차단(블로킹)(Head-Of-the-Line)
  - 입력 큐에서 출력포트로 보내질 때 큐 앞에 있는 패킷이 대기중이면 뒤에 있는 패킷을 출력포트에 경쟁자가 없어도 앞 패킷이 빠지기 전까지 대기해야한다
### Drop-Tail
  - 들어오는 패킷을 저장할 메모리가 충분하지 않을 때 도착한 패킷을 삭제
### AQM(Active Queue Management)알고리즘
  - 패킷 삭제 / 패킷 마킹
  - RED(Random Early Detection)
  - PIE(Proportional Integral Controller Enhanced)
### 패킷 스케줄러(Packet Scheduler)
### 버퍼블로트(Bufferbloat)
  - 패킷의 과도한 버퍼링으로 인해 생기는 패킷 교환 네트워크의 높은 대기 시간의 원인
  - 지속적 버퍼링으로 인한 긴 지연시간
### FCFS(First-Come-First-Served)
### FIFO(First-In-First-Out)
### 비선점 우선순위 큐잉(Non-Preemptive Priority Queuing)
  - 현재 전송중인 패킷의 우선순위보다 새로 도착한 패킷의 우선순위가 높더라도 패킷의 전송이 시작되면 중단하지 않고 해당 작업 완료 후 도착 패킷중에서 우선순위가 높은것 부터 처리한다
### 작업 보존 큐잉(Work-Conserving Queuing)
  - 전송을 위해 큐에서 기다리는 패킷이 있다면 링크는 유휴 상태가 되는것을 불허함
### 망 중립성
  - No Blocking
    - 합적적인 콘텐츠 장치를 차단하면 안됨
  - No Throttling
    - 서비스 또는 해를 끼치지 않는 장치의 사용에 따라 합법적인 인터넷 트래픽을 손상시키거나 저하시켜서는 안됨
  - No Paid Prioitization
    - 유료 우선순위에 관여해서는 안된다
### WFQ(Weighted Fair Queuing)규칙
  - 도착하는 패킷은 적절한 클래스별 대기 영역에서 분류되며 대기함
  - 라운드 로빈 스케줄링처럼 순환방식으로 동작
  - 각 클래스마다 다른 양(가중치)의 서비스 시간을 부여받는다
## 4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등
### IP(Internet Protocol)
### 데이터그램(Datagram)
  - 인터넷 네트워크 계층 패킷
### > IPv4 데이터그램 주요 필드
  - 버전 번호
  - 헤더 길이
  - 서비스 타입(TOS, Type Of Service)
  - 데이터그램 길이
  - 식별자, 플래그, 단편화 오프셋
  - TTL(Time-to-live)
    - 네트워크에서 데이터그램이 무한히 순환하지 않도록 함
  - 프로토콜
  - 헤더 체크섬
  - 출발지와 목적지 IP 주소
  - 옵션
  - 데이터(페이로드)
### 인터페이스(interface)
  - 호스트와 물리적 링크 사이의 경계
### 기술 면에서 IP주소는 인터페이스를 포함하는 호스트 라우터보다 인터페이스와 관련됨
### 점으로 구분하는 십진 표기법(Dotted-Decimal Notation)
  - 주소 표현
### 서브넷(Subnet)
  - 세 호스트들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크
  - 서브넷을 결정하려면 먼저 호스트나 라우터에서 각 인터페이스를 분리하고 고립된 네트워크를 만드는데 이 고립된 네트워크의 종단점은 인터페이스의 끝이 된다. 이렇게 고립된 네트워크 각각을 서브넷이라 칭함
### 서브넷 마스크(Subnet Mask)
  - /N
### CIDR(Classless InterDomain Routing)
  - 서브넷 주소체계 표기를 일반화함
### 최상위 비트(MSB, Most Significant Bit)
### (네트워크) 프리픽스
### 클래스 주소체계(Classful Addressing)
  - CIDR가 채택되기 전 IP주소의 네트워크 부분을 8, 16, 24비트로 제한했는데 이를 각각 A, B, C클래스 네트워크로 분류함
### 경로 집약(Route Aggregation), 주소 집약(Addresss Aggregation), 경로 요약(Route Summarization)
  - 여러 네트워크를 알리기 위해 하나의 네트워크 프리픽스를용사용
### 동적 호스트 구성 프로토콜(DHCP, Dynamic Host Configuration Protocol)
  - 호스트가 IP주소를 자동으로 획득하게 함
  - 플러그 앤 플레이 프로토콜(Plug-and-play protocol), 제로 구성 프로토콜(Zero-Configuration Protocol)이라고 부름
### > DHCP 프로토콜 4단계 과정
  1. DHCP 서버 발견
    - DHCP 발견 메세지(DHCP discover message)
  3. DHCP 서버 제공
    - DHCP 제공 메시지(DHCP offer message)
    - IP 주소 임대 기간(IP 주소가 유효한 시간, IP address lease time)
  5. DHCP 요청
    - DHCP 요청 메시지(DHCP request message)
  7. DHCP ACK
    - DHCP ACK 메시지(DHCP ACK message)
### ISC(Internet Systems Consortium)
  - DHCP 구현에 대한 오픈소스를 이용할 수 있는 곳
### SOHO(Small Office, Home Office) 네트워크
### 네트워크 주소 변환(NAT, Network Address Translation)
  - 주소 할당 방법
### 사설망(Private Network)
### 사설 개인 주소를 갖는 권역(Realm)
### NAT 변환 테이블(NAT Translation table)
### NAT 순회(traversal) 도구
### IETF(Internet Engineering Task Force)
### > IPv6에 도입된 주요한 변화
  1. 확장된 주소기능
    - 애니캐스트 주소(Anycast Address)
  3. 간소화된 40바이트 헤더
  4. 흐름 레이블링
### > IPv6에 정의된 필드
  1. 버전
  2. 트래픽 클래스
  3. 흐름 레이블
  4. 페이로드 길이
  5. 다음 헤더
  6. 홉 제한
  7. 출발지와 목적지 주소
  8. 데이터
### > IPv6에 없는 IPv4에 있는 필드
  1. 단편화/재결합
  2. 헤더 체크섬
  3. 옵션
### 터널링(Tunneling)
  - IPv4 에서 IPv6로 전환하는 방법
## 4.4 일반화된 포워딩 및 소프트웨어 기반 네트워크(SDN)
### OpenFlow
  - 일반화된 포워딩에 대한 논의가 되는 기반
### 플로우 테이블(Flow Table)
  - 매치 플러스 액션
    - 들어오는 패킷에 대한 헤더값들의 세트가 매치됨
    - 패킷들에 의해 갱신되는 카운터세트는 플로우 테이블 엔트리들과 매치됨
    - 패킷이 플로우 테이블 엔트리와 매치될 때 여러 가지 액션이 가능해짐
    - 제한된 형태의 프로그래밍 가능성(Programmability)
### > 가장 중요한 액션
  1. 포워딩(Forwarding)
  2. 삭제(Dropping)
    - 아무 액션이 없는 플로우 테이블 엔터리는 매치된 패킷을 삭제해야 함을 나타냄
  4. 필드 수정(Modify-Field)
    - 패킷이 선택된 출력 포트로 전달되기 전에 10개의 패킷 헤더 필드의 값을 다시 씀
### P4(Programming Protocol-independent Packet Processors)
  - 변수, 범용 산술, 진릿값 연산과 같은 높은 수준의 구조를 가진 변수, 함수 및 조건문 뿐 만 아니라 라인 속도로 데이터그램 처리를 위해 특별히 설계된 구조체를 가진 프로그래밍 언어
## 4.5 미들박스(MiddleBox)
  - 출발지 호스트와 목적지 호스트 사이의 데이터 경로에서 IP라우터의 정상적이고 표준적인 기능과는 별도로 기능을 수행
### > 미들박스가 수행하는 3가지 유형의 서비스
  1. NAT 변환
  2. 보안 서비스
    - DPI(Deep Packet Inspection)
  3. 성능 향상
### 네트워크 기능 가상화(NFV, Network Function Virtualization)
  - 미들박스가 확산됨에 따라 수행원은 이 장비를 운영, 관리, 업그레이드의 필요성 발생
  - 별도의 특수 하드웨어, 소프트웨어 관리/운영 기술은 상당한 운영/자본적 비용으로 이어지기 때문에 일반적인 소프트웨어 스택위에 구축된 전문화된 소프트웨어와 함께 사용할 수 있는 하드웨어의 사용을 탐구
### IP 모래시계(IP Hourglass)
  - 좁은 허리
    - 다른 계층에는 많은 프로토콜이 존재하지만 네트워크 계층에는 IP 프로토콜만이 존재
### 엔드 투 엔드 인수
  - 미들박스의 등장 전까지 대부분의 인터넷 기능이 네트워크의 가장자리에 배치
  - 신뢰할 수 있는 데이터 전송
  - 통신 시스템의 끝점에 위치한 애플리케이션의 지식과 도움을 통해서만 완전하고 정확하게 구현 가능
  - 낮은 수준의 기능 구현
